$(document).ready(function() {

	// Variables
	var first = false;
	var flagintent = true;
	var intenttime = 700;
	var intent;

	// Change intent behaviour on pressing F
	// $(document).keydown(function(e){ 
	// 	if(e.keyCode == 70) {
	// 		if (flagintent == true) {
	// 			flagintent = false;
	// 		} else {
	// 			flagintent = true;
	// 		}
	// 	}
	// });

	// Pagination
	function pagination(){

		totalpages = $('.inner.active .article-content .page').length-1;
		currentpage = $('.inner.active .article-content .page:visible').index();		
		nextpage = currentpage + 1;

		$('.inner.active .pagination .val-current').text(currentpage+1);
		$('.inner.active .pagination .val-total').text(totalpages+1);

		var scrollpush = 153 * (nextpage-1);
		$('.inner.active .scrollbar .handle').css('margin-top',scrollpush + 'px');

	}

	// Article update
	function articleupdate(){

		clearTimeout(intent);
		intent = setTimeout(function(){ 

			var current = $('.article .inner.active').index();
			var selected = $('.carousel .card.focus').index();

			if($('.article .inner:eq(' + selected + ')').hasClass('active')) {

			} else {

				$('.carousel .card').removeClass('open');
				$('.carousel .card.focus').addClass('open');

				$('.article .inner').removeClass('active');

				setTimeout(function(){
					$('.article .inner:eq(' + selected + ')').addClass('active');
					$('.card.open .progress').css('width','33%');
				},500);

			}

		}, intenttime);

	}

	// Number of articles read
	function articlesread(){

		var articlestotal = parseInt($('.carousel .card').length);
		var articlesread = parseInt($('.carousel .card.read').length);
		var articlesleft = parseInt(articlestotal - articlesread);
		console.log(articlestotal);
		console.log(articlesread);
		console.log(articlesleft);

		$('.screen-article .header .subtitle span').text(articlesleft);

	}

	// Press a key
	$(document).keydown(function(e){ 

		// Dashboard
		if ($('body').hasClass('state-dashboard')){

			// If enter is pressed
			if(e.keyCode == 13) {

				articlesread();

				$('.screen-dashboard').hide();
				$('.screen-article').show();

				if (first == false) {

					$('.carousel .card:eq(0)').removeClass('focus');

					$('.article .inner').removeClass('active');
					setTimeout(function(){
						$('.article .inner:eq(0)').addClass('active');
					},400);

					setTimeout(function(){
						$('.carousel .card:eq(0)').addClass('focus open');
					},1);

					first = true;

				}

				setTimeout(function(){
					$('body').removeClass().addClass('state-article-carousel');
				},10);

			}

		}		

		// Article - Carousel
		if ($('body').hasClass('state-article-carousel')){

			var current = $('.carousel .inner .card.focus').index();
			var total = $('.carousel .inner .card').length - 1;

			// Up
			if(e.keyCode == 38) {

				var prev = current - 1;
				var prevpos = (-220) * prev + 90;

				if (current > 0) {

					$('.carousel .inner .card.focus').removeClass('focus');
					$('.carousel .inner .card:eq(' + prev + ')').addClass('focus');

					if (prev == 0) {

						$('.carousel .inner').css('top', '0px');

					} else {

						$('.carousel .inner').css('top', + prevpos + 'px');

					}

					if (flagintent == true) {
						articleupdate();
					}

				}

			}

			// Down
			if(e.keyCode == 40) {

				var next = current + 1;
				var nextpos = (-220) * next + 90;

				if (current < total) {

					$('.carousel .inner .card.focus').removeClass('focus');
					$('.carousel .inner .card:eq(' + next + ')').addClass('focus');

					$('.carousel .inner').css('top', + nextpos + 'px');

					if (flagintent == true) {
						articleupdate();
					}

				}

			}

			// Enter
			if(e.keyCode == 13) {

				var current = $('.article .inner.active').index();
				var selected = $('.carousel .card.focus').index();

				if(flagintent == true) {

					if (current == selected) {

						$('.carousel').removeClass('active');
						$('.article').addClass('active');
						$('body').removeClass().addClass('state-article-scroll');

					} else {

						$('.article .inner').removeClass('active');
						setTimeout(function(){
							$('.article .inner:eq(' + selected + ')').addClass('active');
		
							$('.carousel .card').removeClass('open');
							$('.carousel .card.focus').addClass('open');

							$('.card.open .progress').css('width','33%');

							$('.carousel').removeClass('active');
							$('.article').addClass('active');
							$('body').removeClass().addClass('state-article-scroll');
		
						},500);

					}

				}

				if(flagintent == false) {

					if (current == selected) {

						$('.carousel').removeClass('active');
						$('.article').addClass('active');
						$('body').removeClass().addClass('state-article-scroll');

					} else {

						$('.article .inner').removeClass('active');
						setTimeout(function(){
							$('.article .inner:eq(' + selected + ')').addClass('active');
		
							$('.carousel .card').removeClass('open');
							$('.carousel .card.focus').addClass('open');

							$('.card.open .progress').css('width','33%');

							$('.carousel').removeClass('active');
							$('.article').addClass('active');
							$('body').removeClass().addClass('state-article-scroll');
		
						},500);

					}

				}

			}


			// Right
			if(e.keyCode == 39) {

				$('.carousel').removeClass('active');
				$('.article').addClass('active');
				$('body').removeClass().addClass('state-article-scroll');

			}

			// Backspace
			if(e.keyCode == 8 || e.keyCode == 37) {

				$('.screen-dashboard').show();
				$('.screen-article').hide();
				setTimeout(function(){
					$('body').removeClass().addClass('state-dashboard');
				},10);

				if(e.keyCode == 8) { console.log('Backspace from carousel'); }			
				if(e.keyCode == 37) { console.log('Left from carousel'); }			

			}

		}

		// Article
		if ($('body').hasClass('state-article-scroll')){

			// Left or Back
			if(e.keyCode == 37 || e.keyCode == 8) {

				$('.carousel').addClass('active');
				$('.article').removeClass('active');
				$('body').removeClass().addClass('state-article-carousel');

				if(e.keyCode == 8) { console.log('Backspace from article'); }			
				if(e.keyCode == 37) { console.log('Left from article'); }	

			}

			// Up
			if(e.keyCode == 38) {

				var current = $('.article .inner.active .page:visible').index();
				var total = $('.article .inner.active .page').length;
				var prev = current - 1;

				if (prev > -1) {

					$('.article .inner.active .page').hide();
					$('.article .inner.active .page:eq(' + prev + ')').show();
					pagination();

				}

			}

			// Down
			if(e.keyCode == 40) {

				var current = $('.article .inner.active .page:visible').index();
				var total = $('.article .inner.active .page').length;
				var next = current + 1;

				if ($('.article .inner.active .page:eq(' + next + ')').length) {

					$('.article .inner.active .page').hide();
					$('.article .inner.active .page:eq(' + next + ')').show();
					pagination();

					$('.card.open .progress').css('width','66%');

				}

				// Reached last page of article
				// if (next === (total-1)) {
					
				// 	$('.card.open .progress').css('width','100%');
				// 	setTimeout(function(){
						
				// 		$('.card.open .progress').css('left','100%');
				// 		$('.carousel .inner .card.open').addClass('read');

				// 		articlesread();
						
				// 		// setTimeout(function(){
				// 		// 	$('.carousel .inner .card.open').addClass('read');
				// 		// },500);

				// 	},0);

				// }

			}

		}

	});

});